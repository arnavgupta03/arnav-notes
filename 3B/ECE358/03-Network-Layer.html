<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-12-05 Thu 14:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Network Layer</title>
<meta name="author" content="Arnav Gupta" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="src/latex.css" />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Network Layer</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org71a2a40">1. Overview</a>
<ul>
<li><a href="#orge20cc81">1.1. Best Effort Service</a></li>
</ul>
</li>
<li><a href="#orgf3926cb">2. Data Plane: The Internet Protocol</a>
<ul>
<li><a href="#orgcc2779c">2.1. Fragmentation and Assembly</a></li>
<li><a href="#org051ecee">2.2. IPv4 Addressing</a>
<ul>
<li><a href="#org9960a41">2.2.1. Subnets</a></li>
<li><a href="#org713ce74">2.2.2. DHCP</a></li>
<li><a href="#orgdce87b2">2.2.3. Hierarchical Addressing</a></li>
<li><a href="#org4de358e">2.2.4. Network Address Translation (NAT)</a></li>
<li><a href="#org5f0000b">2.2.5. Middleboxes</a></li>
</ul>
</li>
<li><a href="#org7075dbf">2.3. IPv6 Addressing</a></li>
</ul>
</li>
<li><a href="#org9eab27a">3. What&rsquo;s Inside a Router</a>
<ul>
<li><a href="#org2821e5f">3.1. Switching Fabrics</a>
<ul>
<li><a href="#org80570cb">3.1.1. Switching via Memory</a></li>
<li><a href="#orgc6575cf">3.1.2. Switching via Bus</a></li>
<li><a href="#org3799d91">3.1.3. Interconnection Network</a></li>
</ul>
</li>
<li><a href="#orgbfb80d6">3.2. Port Queuing</a>
<ul>
<li><a href="#org1e65c3e">3.2.1. Input Port Queuing</a></li>
<li><a href="#org4de3e57">3.2.2. Output Port Queuing</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org56d4402">4. Control Plane: ICMP, Routing</a>
<ul>
<li><a href="#orga040fa3">4.1. ICMP</a></li>
<li><a href="#orgfb3423d">4.2. Routing</a>
<ul>
<li><a href="#orge3cde02">4.2.1. Intra-AS Routing</a></li>
<li><a href="#org1515128">4.2.2. Inter-AS Routing: BGP</a></li>
</ul>
</li>
<li><a href="#org4c9d277">4.3. Software Defined Networking</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org71a2a40" class="outline-2">
<h2 id="org71a2a40"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<p>
Network layer protocols transport segments from sending to receiving hosts.
The <span class="underline">sender</span> encapsulates segments into datagrams and passes them to the link
layer. The <span class="underline">receiver</span> delivers segments to the transport layer protocol.
</p>

<p>
Every Internet device uses network layer protocols.
</p>

<p>
<b>Routers</b> examine header fields in all IP datagrams passing through them
and move datagrams from input interfaces to output inferfaces to
transfer datagrams along end-to-end paths.
</p>

<p>
Key network-layer functions:
</p>
<ul class="org-ul">
<li><b>forwarding</b>: move packets from a router&rsquo;s input link to appropriate
router output links (done for all datagrams very fast)</li>
<li><b>routing</b>: network-wide process that determines route taken by packets
from source to destination to fill forwarding tables (done in the background,
takes longer), uses routing algorithms</li>
</ul>

<p>
The <b>data plane</b> is a local, per-router function and determines how a datagram
arriving on router input interface is forwarded to router output interface.
</p>

<p>
The <b>control plane</b> uses network-wide logic to determine how a datagram is routed
among routers along end-to-end paths from source host to destination host.
</p>

<p>
Control plane approaches:
</p>
<ul class="org-ul">
<li><b>traditional routing algorithms</b>: implemented in routers (both planes implemented
monolithically within a router)
<ul class="org-ul">
<li>individual routing algorithm components in every router interact in the control
plane</li>
</ul></li>
<li><b>software-defined networking</b>: explicitly separate the two planes by implementing
the control plane as a service in remote servers
<ul class="org-ul">
<li>remote controller computes and installs forwarding tables in routers</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orge20cc81" class="outline-3">
<h3 id="orge20cc81"><span class="section-number-3">1.1.</span> Best Effort Service</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The Internet runs on a &ldquo;best effort&rdquo; service model, so there are no guarantees on:
</p>
<ul class="org-ul">
<li>successful datagram delivery to the destination</li>
<li>timing or order of delivery</li>
<li>bandwidth available for end-to-end flow</li>
</ul>

<p>
Best effort is simple and has allowed Internet to be widely adopted.
Successful provisioning of bandwidth allows performance of real-time
applications to be good enough for most of the time.
</p>

<p>
Replicated, application-layer distributed services connect close to client networks
which allows services to be provided from multiple locations.
</p>
</div>
</div>
</div>
<div id="outline-container-orgf3926cb" class="outline-2">
<h2 id="orgf3926cb"><span class="section-number-2">2.</span> Data Plane: The Internet Protocol</h2>
<div class="outline-text-2" id="text-2">
<p>
Data plane is:
</p>
<ul class="org-ul">
<li>connectionless (datagram-based)</li>
<li>best-effort delivery
<ul class="org-ul">
<li>packets can be lost, delivered out of order, or delayed</li>
</ul></li>
<li>a common packet format for IPv4 and new packet format for IPv6</li>
<li>global addressing for identifying all hosts (ARP)</li>
<li>sister protocol that performs error reporting and enables signaling between
routers: ICMP (v4, v6)</li>
</ul>

<p>
IPv4 datagram has
</p>
<ul class="org-ul">
<li>IP version number</li>
<li>header length (bytes)</li>
<li>type of service</li>
<li>total datagram length (bytes)</li>
<li>16-bit identifier</li>
<li>flag</li>
<li>fragmentation/reassembly and offset info</li>
<li>time to live: remaining max hops</li>
<li>upper layer protocol (TCP or UDP)</li>
<li>header checksum</li>
<li>32-bit source IP address</li>
<li>32-bit destination IP address</li>
<li>options (timestamp, record route taken, etc)</li>
<li>payload data</li>
</ul>

<p>
When no options, overhead is 20 bytes.
Upper layer protocol can be:
</p>
<ul class="org-ul">
<li>ICMP: 1</li>
<li>TCP: 6</li>
<li>UDP: 17</li>
<li>IPv4: 4</li>
<li>IPv6: 41</li>
</ul>

<p>
If header checksum detects an error, datagram is dropped.
Must be recomputed at every hop because of TTL and options.
</p>
</div>
<div id="outline-container-orgcc2779c" class="outline-3">
<h3 id="orgcc2779c"><span class="section-number-3">2.1.</span> Fragmentation and Assembly</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Link layer protocols have maximum transfer unit size, which is the largest
possible data size in a frame.
</p>

<p>
Large IP datagrams can be divided (fragmented) within a network, and then
reassembled at the final destination.
IP header bits are used to identify and order related fragments.
</p>

<p>
A receiver cannot hold fragments forever and fragments can arrive out of order,
so loss of fragments can mean loss of entire datagram.
The receiver starts a timer when the first fragment of a datagram arrives.
If the timer expires before all the fragments are received, those already
received are discarded.
</p>

<p>
Fragmentation complicated routers and end-systems, which is used by attackers.
</p>
</div>
</div>
<div id="outline-container-org051ecee" class="outline-3">
<h3 id="org051ecee"><span class="section-number-3">2.2.</span> IPv4 Addressing</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<b>IP address</b>: 32-bit identifier associated with each host or router interface
(about 4 billion total)
</p>

<p>
<b>Interface</b>: connection between host/router and physical link
</p>
<ul class="org-ul">
<li>routers typically have multiple interfaces</li>
<li>hosts typically have 1 or 2 interfaces</li>
</ul>
</div>
<div id="outline-container-org9960a41" class="outline-4">
<h4 id="org9960a41"><span class="section-number-4">2.2.1.</span> Subnets</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
The addressing scheme is <b>Classless InterDomain Routing (CIDR)</b>:
</p>
<ul class="org-ul">
<li>IP addresses have a subnet part and a host part</li>
<li>the subnet portion of the address has arbitrary length</li>
<li>the address has format a.b.c.d/x where x is the prefix, the number
of bits in the subnet portion</li>
</ul>

<p>
<b>Subnet</b>: set of interfaces that have IP addresses with the same
prefix and same subnet portion, and can physically reach each other
without passing through an intervening router
</p>

<p>
A subnet mask is x 1 bits followed by 0 bits, which is bitwise ANDed
to the IP address.
With masking, for the same subnet, can send a datagram directly to the
destination and for a different subnet, send the datagram to the router.
</p>
</div>
</div>
<div id="outline-container-org713ce74" class="outline-4">
<h4 id="org713ce74"><span class="section-number-4">2.2.2.</span> DHCP</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
An IP address can be hard-coded by sysadmin in the config file or using
<b>DHCP (Dynamic Host Configuration Protocol)</b> which dynamically gets
address from a server when the host joins the network.
</p>

<p>
DHCP allows:
</p>
<ul class="org-ul">
<li>addresses to be renewed on use</li>
<li>reused since only holding addresses while host connected/on</li>
</ul>

<p>
For a client-server protocol using UDP, DHCP is a network function
implemented as an application protocol:
</p>
<ul class="org-ul">
<li>host broadcasts DHCP discover message</li>
<li>DHCP server responds with DHCP offer message</li>
<li>host requests IP address with a DHCP request message</li>
<li>DHCP server sends the address with a DHCP ack message</li>
</ul>

<p>
Only last 2 steps are needed if the client remembers and wishes
to reuse a previously allocated network address.
</p>

<p>
A DHCP server is co-located in the router, serving all subnets to which
the router is attached.
</p>

<p>
DHCP also returns:
</p>
<ul class="org-ul">
<li>address of first hop router for client</li>
<li>name and IP address of DNS server</li>
<li>address prefix (indicating network vs host portion of address)</li>
</ul>

<p>
For a network to get the subnet part of the IP address, it gets
allocated a portion of its provider ISP&rsquo;s address space.
</p>
</div>
</div>
<div id="outline-container-orgdce87b2" class="outline-4">
<h4 id="orgdce87b2"><span class="section-number-4">2.2.3.</span> Hierarchical Addressing</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Allows efficient advertisement of routing info.
</p>

<p>
When the router receives a datagram with some destination address:
</p>
<ol class="org-ol">
<li>mask the destination address with the mask for that row of the
forwarding table</li>
<li>check if the results correspond to the value in the table, if so
then remember as candidate for forwarding, and then regardless
continue to the next row
<ol class="org-ol">
<li>if there are no candidates, datagram sent to otherwise
output interface</li>
<li>if there is one candidate, datagram sent to the corresponding
output interface</li>
<li>if there are multiple candidates (due to multiple routes to some
host), the most specific one is taken: <b>longest prefix rule</b></li>
</ol></li>
</ol>

<p>
To get a block of addresses, ICANN (Internet Corportation for Assigned
Names and Numbers) allocates IP addresses through 5 regional registries (RRs)
and manages DNS.
</p>

<p>
DHCP and NAT help with IPv4 address space exhaustion.
IPv6 has 128-bit address space.
</p>
</div>
</div>
<div id="outline-container-org4de358e" class="outline-4">
<h4 id="org4de358e"><span class="section-number-4">2.2.4.</span> Network Address Translation (NAT)</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Limiting the number of addresses and re-using IP addresses in a smart way.
</p>

<p>
Addresses in a private address space are not routable outside it and can
be reused as much as desired.
</p>

<p>
Advantages:
</p>
<ul class="org-ul">
<li>range of addresses not needed from ISP: just one IP address for all devices</li>
<li>can change addresses of devices in local network without notifying
outside world</li>
<li>can change ISP without changing addresses of devices in local network</li>
<li>devices inside local net not explicitly addressable or visible by outside
world</li>
</ul>

<p>
Host creates IP datagrams with source and destination IP address that carries
1 transport layer segment. Each segment has source and destination port
numbers (Layer 4 entity).
</p>

<p>
Client knows the port number at the server for the service it needs and OS
selects a unique source port number.
</p>

<p>
Receiving host uses IP addresses and port numbers to direct segment to appropriate
process (via sockets).
</p>

<p>
All devices in local network share just one IPv4 address to the outside world:
</p>
<ul class="org-ul">
<li>all datagrams leaving local network share same source NAT IP address but
different source port numbers</li>
<li>datagrams with source or destination in local network have subnetted address
for source and destination, as usual</li>
</ul>

<p>
The NAT router must transparently:
</p>
<ul class="org-ul">
<li>for outgoing datagrams, replace source IP address and port number of every
outgoing datagram to NAT IP address and new port number
<ul class="org-ul">
<li>remote clients and servers will respond using the NAT IP address and
new port number as destination address</li>
</ul></li>
<li>remember in the NAT translation table every pair of source IP address and port
number to NAT IP address and new port number translation mapping</li>
<li>for incoming datagrams, replace the NAT IP address and new port number in the
destination fields of every incoming datagram with the corresponding
source IP address and port number stored in the NAT table</li>
</ul>

<p>
The 16-bit port number field allows 60000 simultaneous connections with a single
public IP address.
</p>

<p>
The router keeps NAT entries in the translation table for a configurable length
of time.
For TCP connections, default timeout is 24 hours.
Since UDP is not connection based, default timeout is 5 minutes.
</p>

<p>
NAT is controversial since:
</p>
<ul class="org-ul">
<li>routers should only process up to layer 3</li>
<li>address shortage should be solved by IPv6</li>
<li>violates end-to-end argument since port number is manipulated by
network-layer device</li>
<li>can be tricky if client wants to connect to the server behind NAT</li>
</ul>
</div>
</div>
<div id="outline-container-org5f0000b" class="outline-4">
<h4 id="org5f0000b"><span class="section-number-4">2.2.5.</span> Middleboxes</h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
Any intermediate box performing functions apart from normal, standard functions
of an IP router on the data path between a source host and destination host.
</p>

<p>
Includes NAT, application-specific, firewalls, intrusion detection systems,
load balancers, and caches.
</p>

<p>
The internet has a thin waist, since there is a single network layer protocol: IP
that must be implemented by every Internet-connected device (compared to
many protocols in other layers).
</p>

<p>
Middleboxes give love handles that operate inside the network.
</p>
</div>
</div>
</div>
<div id="outline-container-org7075dbf" class="outline-3">
<h3 id="org7075dbf"><span class="section-number-3">2.3.</span> IPv6 Addressing</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Possibly not enough 32-bit IPv4 addresses. Also, IPv4 is slow (variable length header).
IPv6 allows different network-layer treatment of flows and better mobility management.
</p>

<p>
IPv6 datagram has:
</p>
<ul class="org-ul">
<li>IP version</li>
<li>priority among datagrams in flow</li>
<li>flow label: identify datagrams in same flow</li>
<li>payload length</li>
<li>next header</li>
<li>hop limit</li>
<li>128-bit source address</li>
<li>128-bit destination address</li>
<li>data payload</li>
</ul>

<p>
Compared to IPv4, has no checksum, fragmentation/reassembly, and options.
</p>

<p>
Not all routers can be upgraded simultaneously so must operate with mixed IPv4
and IPv6.
</p>

<p>
<b>Tunneling</b>: IPv6 datagram is carried as payload in IPv4 datagram among IPv4
routers (packet within a packet)
</p>

<p>
44.5% of clients access services via IPv6, so takes time to deploy.
</p>
</div>
</div>
</div>
<div id="outline-container-org9eab27a" class="outline-2">
<h2 id="org9eab27a"><span class="section-number-2">3.</span> What&rsquo;s Inside a Router</h2>
<div class="outline-text-2" id="text-3">
<p>
High-level view of generic router architecture has <b>routing processor</b> (control plane) and
<b>high-speed switching fabric</b> (data plane).
</p>

<p>
Input ports have a physical layer, link layer, and decentralized switching (using header
field values, lookup output port using forwarding table in input port memory).
</p>

<p>
<b>Destination-based forwarding</b>: forward based only on destination IP address
</p>

<p>
<b>Generalized forwarding</b>: forward based on any set of header field values
</p>
</div>
<div id="outline-container-org2821e5f" class="outline-3">
<h3 id="org2821e5f"><span class="section-number-3">3.1.</span> Switching Fabrics</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Transfer packets from input link to appropriate output link.
</p>

<p>
<b>Switching rate</b>: rate at which packets can be transferred from inputs to outputs,
measured as multiple of input/output line rate
</p>

<p>
For \(N\) inputs, switching rate of \(N\) times the line rate is desirable.
</p>

<p>
Major types of switching fabrics are:
</p>
<ul class="org-ul">
<li>memory</li>
<li>bus</li>
<li>interconnection network</li>
</ul>
</div>
<div id="outline-container-org80570cb" class="outline-4">
<h4 id="org80570cb"><span class="section-number-4">3.1.1.</span> Switching via Memory</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Used traditionally, with switching under direct control of CPU.
</p>

<p>
The packet is copied into system memory and speed is limited by memory bandwidth
(2 bus crossings per datagram).
</p>
</div>
</div>
<div id="outline-container-orgc6575cf" class="outline-4">
<h4 id="orgc6575cf"><span class="section-number-4">3.1.2.</span> Switching via Bus</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Datagram from input port memory to output port memory via shared bus.
</p>

<p>
<b>Bus contention</b>: switching speed is limited by bus bandwidth
</p>
</div>
</div>
<div id="outline-container-org3799d91" class="outline-4">
<h4 id="org3799d91"><span class="section-number-4">3.1.3.</span> Interconnection Network</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Initially developed to connect processors in multiprocessor.
</p>

<p>
<b>Multistage switch</b>: \(n \times n\) switch from multiple stages of smaller switches
</p>

<p>
With parallelism:
</p>
<ul class="org-ul">
<li>fragment datagram into fixed length cells on entry</li>
<li>switch cells through the fabric and reassemble datagram at exit</li>
</ul>

<p>
Can scale by using multiple switching planes in parallel.
</p>

<p>
Cisco CRS router:
</p>
<ul class="org-ul">
<li>basic unit has 8 switching planes</li>
<li>each plane has a 3 stage interconnection network</li>
<li>up to 100s of Tbps switching capacity</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbfb80d6" class="outline-3">
<h3 id="orgbfb80d6"><span class="section-number-3">3.2.</span> Port Queuing</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org1e65c3e" class="outline-4">
<h4 id="org1e65c3e"><span class="section-number-4">3.2.1.</span> Input Port Queuing</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
If switch fabric slower than input ports combined, queuing may occur at input queues.
This can lead to queuing delay and loss due to input buffer overflow.
</p>

<p>
<b>Head of the Line (HOL) blocking</b>: queued datagram at front of queue prevents others
in queue from moving forward
</p>
</div>
</div>
<div id="outline-container-org4de3e57" class="outline-4">
<h4 id="org4de3e57"><span class="section-number-4">3.2.2.</span> Output Port Queuing</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Buffering occurs when arrival rate via switch exceeds output line speed.
</p>

<p>
Queuing delay (and loss) due to output port buffer congestion (overflow).
</p>

<p>
<b>Buffering</b> is required when datagrams arrive from fabric faster than the link
transmission rate.
Must have <b>drop policy</b> to decide which datagrams to drop if no free buffers.
</p>

<p>
<b>Scheduling discipline</b> chooses among queued datagrams for transmission.
With priority scheduling, this decides who gets best performance.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org56d4402" class="outline-2">
<h2 id="org56d4402"><span class="section-number-2">4.</span> Control Plane: ICMP, Routing</h2>
<div class="outline-text-2" id="text-4">
<p>
Even though best effort, IP attempts to avoid errors and report problems when they
occur.
</p>

<p>
IP does introduce errors or ignore all errors.
</p>

<p>
Errors detected can be:
</p>
<ul class="org-ul">
<li>corrupted header bits: header checksum</li>
<li>illegal addresses: routing tables</li>
<li>routing loop: TTL field</li>
<li>fragment loss: timeout</li>
</ul>
</div>
<div id="outline-container-orga040fa3" class="outline-3">
<h3 id="orga040fa3"><span class="section-number-3">4.1.</span> ICMP</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Internet Control Message Protocol is a separate protocol for errors reporting and
information.
Required part of IP (just above IP, layer 3.5) and sends error message to
original source.
</p>

<p>
Used by hosts and routers to communicate network-level info like error reporting
(unreachable host, network, port, protocol, etc.) and uses echo request/reply (used
by ping).
</p>

<p>
Network-layer above IP so ICMP messages carried in IP datagrams.
</p>

<p>
ICMP message has a type, code and first 8 bytes of IP datagram causing error.
</p>

<p>
IP datagram header contains a bit to specify no fragmentation allowed, which can be
bit 0 &rarr; must be zero, bit 1 &rarr; don&rsquo;t fragment, bit 2 &rarr; more fragments.
</p>

<p>
ICMP sends an error message when fragmentation required but not permitted.
This is done by probing to find the largest MTU that does not generate an error
message.
This MTU is not guaranteed if routes change.
</p>

<p>
For traceroute (provides delay measurement from source to router):
</p>
<ul class="org-ul">
<li>source sends sets of UDP segments to destination with an unknown port number
where each set has an increasing TTL starting from 1</li>
<li>datagram in set \(n\) arrives to router \(n\) where router discards datagram
and sends source ICMP message which possibly includes name of router
and IP address</li>
<li>when ICMP message arrives at source, it records RTTs</li>
</ul>

<p>
The stopping criteria for traceroute is that the UDP segment eventually arrives
at destination host.
The destination returns ICMP &ldquo;port unreachable&rdquo; message and so the source stops.
</p>
</div>
</div>
<div id="outline-container-orgfb3423d" class="outline-3">
<h3 id="orgfb3423d"><span class="section-number-3">4.2.</span> Routing</h3>
<div class="outline-text-3" id="text-4-2">
<p>
<span class="underline">Goal</span>: determine good paths/routes from sending host to receiving hosts, through network of
routers
</p>

<p>
<b>Path</b>: sequence of routers packets traverse from given initial source host to final destination
host
</p>

<p>
A good path can have least cost, fastest, least congested, or other criteria.
</p>

<p>
<b>Broadcast routing</b>: route packet from a source to all nodes in the network
</p>

<p>
<b>Flooding</b>: each node sends packet on all outgoing links and discard packets received a second time
</p>

<p>
<b>Spanning Tree routing</b>: send packet along a tree that includes all nodes in the network
</p>

<p>
Internet too big for flat routing:
</p>
<ul class="org-ul">
<li>can&rsquo;t store all destinations in routing tables</li>
<li>each network within the Internet may want to control routing in its own network</li>
</ul>

<p>
<span class="underline">Approach</span>: aggregate routers into regions known as autonomous systems (AS) aka domains
</p>

<p>
<b>Intra-AS</b>: routing within same AS
</p>
<ul class="org-ul">
<li>all routers in AS must run same intra-domain protocol</li>
<li>routers in different AS can run different intra-domain routing protocols</li>
<li><b>gateway router</b>: at edge of AS, has link to routers in other ASs</li>
</ul>

<p>
<b>Inter-AS</b>: routing among ASs
</p>
<ul class="org-ul">
<li>gateways perform inter-domain routing (and intra-domain routing)</li>
</ul>

<p>
Forwarding table configured by intra-AS and inter-AS routing algorithms:
</p>
<ul class="org-ul">
<li>intra-AS routing determine entries for destinations within AS</li>
<li>inter-AS and intra-AS determine entries for external destinations</li>
</ul>

<p>
Intra-AS routing protocols are <b>Interior Gateway Protocols (IGP)</b>:
</p>
<ul class="org-ul">
<li><span class="underline">RIP</span>: Routing Information Protocol</li>
<li><span class="underline">OSPF</span>: Open Shortest Path First</li>
<li><span class="underline">IGRP</span>: Interior Gateway Routing Protocol (Cisco proprietary)</li>
</ul>

<p>
Only Inter-AS routing protocol is BGP (Border Gateway Protocol).
</p>

<p>
<b>Routing algorithm</b>: algorithm that finds least-cost path, used to fill routing tables
</p>

<p>
Routing algorithms can be classified by information and static/dynamic.
</p>

<p>
Some global info vs more local info:
</p>
<ul class="org-ul">
<li><span class="underline">global</span>
<ul class="org-ul">
<li>all routers flood the network with info about link state so a complete map can be created</li>
<li>routes then computed</li>
<li>link state algorithms
<ul class="org-ul">
<li>nodes send info about their distances from their neighbours to all other nodes</li>
</ul></li>
</ul></li>
<li><span class="underline">local</span>
<ul class="org-ul">
<li>each router initially knows physically connected neighbours, exchanges part of its routing table
with its neighbours</li>
<li>iterative process of computation</li>
<li>distance vector algorithms
<ul class="org-ul">
<li>nodes send info about their distances from all other nodes to their neighbours</li>
</ul></li>
</ul></li>
</ul>

<p>
Static vs dynamic:
</p>
<ul class="org-ul">
<li><span class="underline">static</span>: routes change slowly over time</li>
<li><span class="underline">dynamic</span>: routes change more quickly, periodic update in response to link cost changes</li>
</ul>
</div>
<div id="outline-container-orge3cde02" class="outline-4">
<h4 id="orge3cde02"><span class="section-number-4">4.2.1.</span> Intra-AS Routing</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
All routers identical, network considered flat.
</p>

<p>
Cost between links defined by network operator, and costs should be additive.
</p>

<p>
Most routing algorithms use a shortest path algorithm, such as Bellman-Form and Dijkstra&rsquo;s.
</p>

<p>
Can define cost as:
</p>
<ul class="org-ul">
<li><span class="underline">fixed quantity</span> based on link rate, propagation delay, or some combination</li>
<li><span class="underline">time-varying quantity</span> based on average traffic on a link, buffer occupancy, delay, and error
conditions
<ul class="org-ul">
<li>dangerous since oscillations possible</li>
</ul></li>
</ul>

<p>
Dijkstra&rsquo;s link-state routing algorithm is
</p>
<ul class="org-ul">
<li><span class="underline">centralized</span>: network topology, reachability, link costs known to all nodes
<ul class="org-ul">
<li>accomplished via link state broadcast</li>
<li>all nodes have same info</li>
</ul></li>
<li>each router uses Dijkstra&rsquo;s algorithm to compute least cost paths from source to all other
nodes
<ul class="org-ul">
<li>gives forward table for that node</li>
</ul></li>
<li>\(D(v)\) is current estimate of cost of least-cost path from source to destination \(v\)</li>
<li>\(p(v)\) is predecessor node along path from source to \(v\)</li>
<li>\(N'\) is set of nodes whose least-cost path definitively known</li>
</ul>

<p>
Open Shortest Path First (OSPF) routing:
</p>
<ul class="org-ul">
<li>open means publicly available</li>
<li>state of a link is a description of interface on router and its relationship to its neighbouring
routers</li>
<li>description of interface would include IP address of interface, mask, subnet, type of network it
is connected to, routers connected to that network, and more</li>
<li>collection of link-states forms link-state DB</li>
<li>each router floors OSPF link-state advertisements (over IP) to all other routers in entire AS</li>
<li>multiple link costs metrics possible link bandwidth and delay</li>
<li>each router has full topology (subnets) and uses Dijkstra&rsquo;s algorithm to compute forwarding
table</li>
<li><span class="underline">security</span>: all OSPF messages authenticated (to prevent malicious intrusion)</li>
<li>link state packet (LSP) contains
<ul class="org-ul">
<li>id of node that created LSP</li>
<li>cost of link to each directly connected neighbour (typically link rate)</li>
<li>sequence number</li>
<li>TTL for this packet</li>
</ul></li>
<li>advertisements disseminated to entire AS (via flooding, at least once every 30 min or when
changes)</li>
<li>send new LSP with infinite cost to signal a link down</li>
<li>reliable flooding
<ul class="org-ul">
<li>generate new LSP periodically, increment sequence number</li>
<li>store most recent LSP from each node, forward LSP to all nodes but one that sent it, throw all
new copies of same LSP (do not forward)</li>
<li>decrement TTL of each stored LSP regularly, discard when TTL=0</li>
</ul></li>
</ul>

<p>
<b>Two-level hierarchy</b>: local area and backbone
</p>
<ul class="org-ul">
<li>link-state advertisements flooded only in area, or backbone</li>
<li>each node has detailed area topology, only knows direction to reach other destinations</li>
</ul>

<p>
<b>Area border routers</b>: summarize distances to destinations in own area, advertise in backbone
</p>

<p>
<b>Boundary router</b>: connects to other ASs
</p>

<p>
<b>Local router</b>: flood LS in area only, compute routing within area, forward packets to outside via
area border router
</p>

<p>
<b>Backbone router</b>: runs OSPF limited to backbone
</p>

<p>
With distance-vector algorithm, a router never builds a complete map of the network, just
neighbours.
</p>
<ul class="org-ul">
<li>a node computes distance vector whenever it receives something from one of its neighbours</li>
<li>a node sends distance to neighbours whenever it changes</li>
</ul>

<p>
Distributed Bellman Ford used in Distance Vector algorithm:
</p>
<ul class="org-ul">
<li>from time-to-time, each node sends distance vector estimate to neighbours</li>
<li>asynchronous and iterative
<ul class="org-ul">
<li>each local iteration caused by local link cost change or distance vector update message from
neighbours</li>
</ul></li>
<li>whenever a node receives a new distance vector estimate from a neighbour, it updates its own
distance vector using the Bellman Ford equation</li>
<li>under minor, natural conditions, estimate converges to actual least cost</li>
<li>each node notifies neighbours only when distance vector changes
<ul class="org-ul">
<li>neighbours notify neighbours only if necessary</li>
</ul></li>
</ul>

<p>
With distance vector algorithm, iterative communication, so computation steps diffuse information
through network.
Good news travels fast, bad news travels slow.
</p>

<p>
<b>Poisoned reverse</b>: if \(z\) routes through \(y\) to get to \(x\), \(z\) tells \(y\) its distance to \(x\) is
infinite (so \(y\) won&rsquo;t route to \(x\) via \(z\))
</p>

<p>
<b>Routing Information Protocol</b>:
</p>
<ul class="org-ul">
<li>included in BSD-UNIX distribution in 1982</li>
<li>distance vector algorithm
<ul class="org-ul">
<li>distance metric is number of hops (max 15), each link has cost 1</li>
<li>distance vectors exchanged with neighbours every 30 secs in response message (aka
advertisement)</li>
<li>each advertisement is a list of up to 25 destination subnets as well as sender&rsquo;s distance
to each subnet</li>
</ul></li>
<li>if no advertisement heard after 180 secs, neighbour/link declared dead
<ul class="org-ul">
<li>routes via neighbour invalidated</li>
<li>new advertisements sent to neighbours</li>
<li>neighbours in turn send out new advertisements (if tables changed)</li>
<li>link failure info quickly propagates to entire net</li>
<li>poison reverse used to prevent ping-pong loops</li>
</ul></li>
</ul>

<p>
Problems with distance vector routing:
</p>
<ul class="org-ul">
<li>convergence is slow</li>
<li>loops can be formed, due to routing table inconsistency: packets being forwarded from router to
router and never reach destination</li>
<li>loops might last until convergence or count to infinity problem</li>
</ul>

<p>
OSPF is better than RIP in stability (robustness to network changes) since distance vector converges
slowly compared to link state.
But, OSPF creates more routing traffic (flooding).
</p>
</div>
</div>
<div id="outline-container-org1515128" class="outline-4">
<h4 id="org1515128"><span class="section-number-4">4.2.2.</span> Inter-AS Routing: BGP</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
De factor inter-domain routing protocol.
Allows subnet to advertise existence and the destinations it can reach, to rest of Internet.
</p>

<p>
BGP provides each AS a means to:
</p>
<ul class="org-ul">
<li><span class="underline">eBGP</span>: obtain subnet reachability info from neighbouring ASs</li>
<li><span class="underline">iBGP</span>: propagate reachability info to all AS-internal routers</li>
<li>determine good routes to other networks based on reachability info and policy</li>
</ul>

<p>
<b>BGP session</b>: two BGP routers exchange BGP messages over semi-permanent TCP connection
</p>
<ul class="org-ul">
<li>advertising paths to different destination network prefixes (BGP is a path vector protocol)
<ul class="org-ul">
<li>advertised route has prefix (destination being advertised) and AS-PATH (list of ASs through
which prefix advertisement has passed) and NEXT-HOP (indicates specific internal-AS router
to next-hop AS)</li>
</ul></li>
</ul>

<p>
<b>Policy-based routing</b>:
</p>
<ul class="org-ul">
<li>gateway receiving route advertisement uses import policy to accept/decline path</li>
<li>AS policy also determines whether to advertise path to other neighbouring ASs</li>
</ul>

<p>
Gateway router may learn about multiple paths to destination, selects route based on:
</p>
<ul class="org-ul">
<li>local preference value attribute: policy decision</li>
<li>shortest AS-PATH</li>
<li>additional criteria</li>
</ul>

<p>
<b>BGP messages</b> are exchanged between peers over TCP connection:
</p>
<ul class="org-ul">
<li><span class="underline">OPEN</span>: opens TCP connection to remote BGP peer and authenticates sending BGP peer</li>
<li><span class="underline">UPDATE</span>: advertises new path (or withdraws old)</li>
<li><span class="underline">KEEPALIVE</span>: keeps connection alive in absence of UPDATEs, also ACKs OPEN request</li>
<li><span class="underline">NOTIFICATION</span>: reports errors in previous message, also used to close connection</li>
</ul>

<p>
Policy:
</p>
<ul class="org-ul">
<li><span class="underline">inter-AS</span>: admin wants control over how its traffic is routed, who routes through its network</li>
<li><span class="underline">intra-AS</span>: single admin, so policy less of an issue</li>
</ul>

<p>
Scale:
</p>
<ul class="org-ul">
<li>hierarchical routing saves table size, reduced update traffic</li>
</ul>

<p>
Performance:
</p>
<ul class="org-ul">
<li><span class="underline">inter-AS</span>: policy dominates over performances</li>
<li><span class="underline">intra-AS</span>: can focus on performance</li>
</ul>

<p>
<b>Hot Potato Routing</b>: choose local gateway that has least intra-domain cost
</p>

<p>
ISP only wants to route traffic to/from its customer networks (not carry traffic between other ISPs).
</p>
</div>
</div>
</div>
<div id="outline-container-org4c9d277" class="outline-3">
<h3 id="org4c9d277"><span class="section-number-3">4.3.</span> Software Defined Networking</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Internet network layer: historically implemented via distributed, per-router control approach:
</p>
<ul class="org-ul">
<li>monolithic router contain switching hardware, runs proprietary implementation of Internet standard
protocols (IP, RIP, IS-IS, OSPF, BGP) in proprietary router OS</li>
<li>different middleboxes for different network layer functions: firewalls, load balancers, NAT boxes</li>
</ul>

<p>
In per-router control plane, individual routing algorithm components in each and every router interact
in the control plane to computer forwarding tables.
</p>

<p>
In SDN control plane, remote controller computes and installs forwarding tables in routers.
</p>

<p>
SDN is <span class="underline">logically centralized</span> since easier network management (avoid router misconfigurations and
greater flexibility of traffic flows), table-based forwarding allows programming routers (centralized
programming easier than distributed programming), and open (non-proprietary) implementation of
control plane (foster innovation).
</p>

<p>
With traditional routing:
</p>
<ul class="org-ul">
<li>link weights are control knobs, so not much control.</li>
<li>load balancing not possible</li>
<li>can&rsquo;t route along different paths from same node</li>
</ul>

<p>
Each router contains a forwarding table: <i>match plus action</i> abstraction, so match bits in arriving
packet then take action
</p>
<ul class="org-ul">
<li><span class="underline">destination-based forwarding</span>: forward based on destination IP address</li>
<li><span class="underline">generalized forwarding</span>: many header fields can determine action and many actions possible</li>
</ul>

<p>
<b>Flow</b>: defined by header field values (in link, network, and transport-layer fields)
</p>

<p>
<b>Generalized forwarding</b>: simple packet-handling rules
</p>
<ul class="org-ul">
<li><span class="underline">match</span>: pattern values in packet header fields</li>
<li><span class="underline">actions</span>: for matched packet &rarr; drop, forward, modify matched packet or send matched packet to
controller</li>
</ul>

<p>
Orchestrated tables can create network-wide behaviour.
</p>

<p>
Intelligence for 20th century phone net was at network switches, for early Internet at edge computing,
and for modern Internet at programmable network devices and application-level infrastructure at edge.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Arnav Gupta</p>
<p class="date">Created: 2024-12-05 Thu 14:43</p>
</div>
</body>
</html>
